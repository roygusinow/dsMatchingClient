name: R-CMD-check

on:
  push:
    branches: [ "master" ]        # or "master" if thatâ€™s your default
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # so remotes() can talk to GitHub for public-org repos
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    strategy:
      matrix:
        r-version: ['4.3.3']

    steps:
    - uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev
        sudo apt-get install -y pandoc

    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: ${{ matrix.r-version }}

    - name: Install remotes explicitly
      run: |
        install.packages("remotes")
      shell: Rscript {0}

    - name: Install panelaggregation explicitly
      run: |
        remotes::install_url("https://cran.r-project.org/src/contrib/Archive/panelaggregation/panelaggregation_0.1.tar.gz")
      shell: Rscript {0}

    - name: Install dsBaseClient explicitly
      run: |
        remotes::install_github("datashield/dsBaseClient@master")
      shell: Rscript {0}

    - name: Install dsBase explicitly
      run: |
        remotes::install_github("datashield/dsBase@master")
      shell: Rscript {0}

    - name: Install dsMatching explicitly
      run: |
        remotes::install_github("roygusinow/dsMatching@master")
      shell: Rscript {0}

    - name: Install remaining deps
      run: |
        install.packages(c("rcmdcheck"))
        remotes::install_deps(dependencies = TRUE)
      shell: Rscript {0}

    - name: Run R CMD check
      run: |
        rcmdcheck::rcmdcheck(args="--no-manual", error_on="error")
      shell: Rscript {0}
    
    # - name: Run R CMD check
    #   run: |
    #     R CMD check --no-manual .
    #   shell: bash
